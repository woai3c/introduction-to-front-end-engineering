<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>什么时候需要监控 | 带你入门前端工程</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/introduction-to-front-end-engineering/assets/css/0.styles.372d6cc5.css" as="style"><link rel="preload" href="/introduction-to-front-end-engineering/assets/js/app.5017e671.js" as="script"><link rel="preload" href="/introduction-to-front-end-engineering/assets/js/2.08dab6ba.js" as="script"><link rel="preload" href="/introduction-to-front-end-engineering/assets/js/13.f75ac3cb.js" as="script"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/10.69ac19bd.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/11.daf2a457.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/12.a3f41b61.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/14.b56fd228.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/15.3f016c5c.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/16.ec0803da.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/17.10ef5f64.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/18.9ce0a2a9.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/19.aa408c4d.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/20.b6eb1a48.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/3.a5d8eb0d.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/4.df3d58d9.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/5.c677297e.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/6.c8b7a84a.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/7.735bc91a.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/8.4daaac08.js"><link rel="prefetch" href="/introduction-to-front-end-engineering/assets/js/9.8f4c6ee8.js">
    <link rel="stylesheet" href="/introduction-to-front-end-engineering/assets/css/0.styles.372d6cc5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/introduction-to-front-end-engineering/" class="home-link router-link-active"><!----> <span class="site-name">带你入门前端工程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/woai3c/introduction-to-front-end-engineering" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码！
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/woai3c/introduction-to-front-end-engineering" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码！
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/introduction-to-front-end-engineering/" aria-current="page" class="sidebar-link">简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#目录" class="sidebar-link">目录</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#注意" class="sidebar-link">注意</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#你会学到什么" class="sidebar-link">你会学到什么？</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#适宜人群" class="sidebar-link">适宜人群</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#license" class="sidebar-link">License</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/#赞助" class="sidebar-link">赞助</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/01.html" class="sidebar-link">技术选型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/01.html#可控性" class="sidebar-link">可控性</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/01.html#稳定性" class="sidebar-link">稳定性</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/01.html#适用性" class="sidebar-link">适用性</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/01.html#易用性" class="sidebar-link">易用性</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/01.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/02.html" class="sidebar-link">统一规范</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/02.html#代码规范" class="sidebar-link">代码规范</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/02.html#git-规范" class="sidebar-link">git 规范</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/02.html#项目规范" class="sidebar-link">项目规范</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/02.html#ui-规范" class="sidebar-link">UI 规范</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/02.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/03.html" class="sidebar-link">前端组件化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/03.html#高内聚-低耦合" class="sidebar-link">高内聚，低耦合</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/03.html#模块化、组件化" class="sidebar-link">模块化、组件化</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/03.html#web-components" class="sidebar-link">Web Components</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/03.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/04.html" class="sidebar-link">测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/04.html#单元测试" class="sidebar-link">单元测试</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/04.html#e2e-测试" class="sidebar-link">E2E 测试</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/04.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/05.html" class="sidebar-link">构建工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/05.html#webpack" class="sidebar-link">webpack</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/05.html#rollup" class="sidebar-link">rollup</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/05.html#vite" class="sidebar-link">vite</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/05.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/06.html" class="sidebar-link">自动化部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/06.html#gitea-jenkins-自动构建前端项目并部署到服务器" class="sidebar-link">Gitea + Jenkins 自动构建前端项目并部署到服务器</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/06.html#github-actions-自动构建前端项目并部署到服务器" class="sidebar-link">Github Actions 自动构建前端项目并部署到服务器</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/06.html#部署方式" class="sidebar-link">部署方式</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/06.html#小结-2" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/07.html" aria-current="page" class="active sidebar-link">前端监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#什么时候需要监控" class="sidebar-link">什么时候需要监控</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#数据采集" class="sidebar-link">数据采集</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#数据上报" class="sidebar-link">数据上报</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#扩展" class="sidebar-link">扩展</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#前端监控部署" class="sidebar-link">前端监控部署</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/07.html#小结-4" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/08.html" class="sidebar-link">性能优化（一）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/08.html#性能优化分类" class="sidebar-link">性能优化分类</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/08.html#加载时性能优化-10-条规则" class="sidebar-link">加载时性能优化 10 条规则</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/09.html" class="sidebar-link">性能优化（二）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/09.html#运行时性能优化-13-条规则" class="sidebar-link">运行时性能优化 13 条规则</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/10.html" class="sidebar-link">重构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/10.html#重构的原则" class="sidebar-link">重构的原则</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/10.html#重构的手法" class="sidebar-link">重构的手法</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/10.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/11.html" class="sidebar-link">微服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/11.html#微服务实践" class="sidebar-link">微服务实践</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/11.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/12.html" class="sidebar-link">Serverless</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/12.html#faas" class="sidebar-link">Faas</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/12.html#baas" class="sidebar-link">Baas</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/12.html#faas-和-baas-的区别" class="sidebar-link">Faas 和 Baas 的区别</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/12.html#阿里云-faas-实践" class="sidebar-link">阿里云 Faas 实践</a></li><li class="sidebar-sub-header"><a href="/introduction-to-front-end-engineering/12.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/introduction-to-front-end-engineering/13.html" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="什么时候需要监控"><a href="#什么时候需要监控" class="header-anchor">#</a> 什么时候需要监控</h2> <ol><li>当你的应用频繁报错找不到原因的时候。</li> <li>需要分析用户兴趣爱好、购买习惯。</li> <li>需要优化程序的时候，可以做监控收集数据，做针对性的优化。</li> <li>需要保证服务可靠性稳定性。</li></ol> <p>如果你的应用符合以上任意一条，就可以对应用实行监控了。监控的作用有两个：事前预警和事后分析。</p> <p><strong>事前预警</strong>：提前设置一个阈值，当监控的数据达到阈值时，通过短信或者邮件通知管理员。例如 API 请求数量突然间暴涨，就得进行报警，否则可能会造成服务器宕机。</p> <p><strong>事后分析</strong>：通过监控日志文件，分析故障原因和故障发生点。从而做出修改，防止这种情况再次发生。</p> <p>本章内容分为前端监控原理分析和如何对项目实行监控两个部分。第一部分有三个小节：数据采集、数据上报、扩展；第二部分只有一个小节：如何使用 <a href="https://docs.sentry.io/" target="_blank" rel="noopener noreferrer">sentry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 实现项目监控。</p> <p>好了，下面让我们开始进入正文吧。</p> <h2 id="数据采集"><a href="#数据采集" class="header-anchor">#</a> 数据采集</h2> <h3 id="性能数据采集"><a href="#性能数据采集" class="header-anchor">#</a> 性能数据采集</h3> <p>性能数据采集需要使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance" target="_blank" rel="noopener noreferrer">window.performance<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> API。</p> <blockquote><p>Performance 接口可以获取到当前页面中与性能相关的信息，它是 High Resolution Time API 的一部分，同时也融合了 Performance Timeline API、Navigation Timing API、 User Timing API 和 Resource Timing API。</p></blockquote> <p>从 MDN 的文档可以看出，<code>window.performance.timing</code> 包含了页面加载各个阶段的起始及结束时间。</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e4dc44264e194cc18424a8fa074a569a~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>这些属性需要结合下图一起看，更好理解：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/44cfc5b680fe46ef8caf2177fd1e67c7~tplv-k3u1fbpfcp-zoom-1.image" alt="在这里插入图片描述"></p> <p>为了方便大家理解 <code>timing</code> 各个属性的意义，我在知乎找到一位网友对于 <code>timing</code> 写的简介，在此转载一下。</p> <div class="language-js extra-class"><pre class="language-js"><code>timing<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 同一个浏览器上一个页面卸载(unload)结束时的时间戳。如果没有上一个页面，这个值会和fetchStart相同。</span>
	navigationStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

	<span class="token comment">// 上一个页面unload事件抛出时的时间戳。如果没有上一个页面，这个值会返回0。</span>
	unloadEventStart<span class="token operator">:</span> <span class="token number">1543806782523</span><span class="token punctuation">,</span>

	<span class="token comment">// 和 unloadEventStart 相对应，unload事件处理完成时的时间戳。如果没有上一个页面,这个值会返回0。</span>
	unloadEventEnd<span class="token operator">:</span> <span class="token number">1543806782523</span><span class="token punctuation">,</span>

	<span class="token comment">// 第一个HTTP重定向开始时的时间戳。如果没有重定向，或者重定向中的一个不同源，这个值会返回0。</span>
	redirectStart<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>

	<span class="token comment">// 最后一个HTTP重定向完成时（也就是说是HTTP响应的最后一个比特直接被收到的时间）的时间戳。</span>
	<span class="token comment">// 如果没有重定向，或者重定向中的一个不同源，这个值会返回0. </span>
	redirectEnd<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>

	<span class="token comment">// 浏览器准备好使用HTTP请求来获取(fetch)文档的时间戳。这个时间点会在检查任何应用缓存之前。</span>
	fetchStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

	<span class="token comment">// DNS 域名查询开始的UNIX时间戳。</span>
        <span class="token comment">//如果使用了持续连接(persistent connection)，或者这个信息存储到了缓存或者本地资源上，这个值将和fetchStart一致。</span>
	domainLookupStart<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

	<span class="token comment">// DNS 域名查询完成的时间.</span>
	<span class="token comment">//如果使用了本地缓存（即无 DNS 查询）或持久连接，则与 fetchStart 值相等</span>
	domainLookupEnd<span class="token operator">:</span> <span class="token number">1543806782096</span><span class="token punctuation">,</span>

	<span class="token comment">// HTTP（TCP） 域名查询结束的时间戳。</span>
        <span class="token comment">//如果使用了持续连接(persistent connection)，或者这个信息存储到了缓存或者本地资源上，这个值将和 fetchStart一致。</span>
	connectStart<span class="token operator">:</span> <span class="token number">1543806782099</span><span class="token punctuation">,</span>

	<span class="token comment">// HTTP（TCP） 返回浏览器与服务器之间的连接建立时的时间戳。</span>
        <span class="token comment">// 如果建立的是持久连接，则返回值等同于fetchStart属性的值。连接建立指的是所有握手和认证过程全部结束。</span>
	connectEnd<span class="token operator">:</span> <span class="token number">1543806782227</span><span class="token punctuation">,</span>

	<span class="token comment">// HTTPS 返回浏览器与服务器开始安全链接的握手时的时间戳。如果当前网页不要求安全连接，则返回0。</span>
	secureConnectionStart<span class="token operator">:</span> <span class="token number">1543806782162</span><span class="token punctuation">,</span>

	<span class="token comment">// 返回浏览器向服务器发出HTTP请求时（或开始读取本地缓存时）的时间戳。</span>
	requestStart<span class="token operator">:</span> <span class="token number">1543806782241</span><span class="token punctuation">,</span>

	<span class="token comment">// 返回浏览器从服务器收到（或从本地缓存读取）第一个字节时的时间戳。</span>
        <span class="token comment">//如果传输层在开始请求之后失败并且连接被重开，该属性将会被数制成新的请求的相对应的发起时间。</span>
	responseStart<span class="token operator">:</span> <span class="token number">1543806782516</span><span class="token punctuation">,</span>

	<span class="token comment">// 返回浏览器从服务器收到（或从本地缓存读取，或从本地资源读取）最后一个字节时</span>
        <span class="token comment">//（如果在此之前HTTP连接已经关闭，则返回关闭时）的时间戳。</span>
	responseEnd<span class="token operator">:</span> <span class="token number">1543806782537</span><span class="token punctuation">,</span>

	<span class="token comment">// 当前网页DOM结构开始解析时（即Document.readyState属性变为“loading”、相应的 readystatechange事件触发时）的时间戳。</span>
	domLoading<span class="token operator">:</span> <span class="token number">1543806782573</span><span class="token punctuation">,</span>

	<span class="token comment">// 当前网页DOM结构结束解析、开始加载内嵌资源时（即Document.readyState属性变为“interactive”、相应的readystatechange事件触发时）的时间戳。</span>
	domInteractive<span class="token operator">:</span> <span class="token number">1543806783203</span><span class="token punctuation">,</span>

	<span class="token comment">// 当解析器发送DOMContentLoaded 事件，即所有需要被执行的脚本已经被解析时的时间戳。</span>
	domContentLoadedEventStart<span class="token operator">:</span> <span class="token number">1543806783203</span><span class="token punctuation">,</span>

	<span class="token comment">// 当所有需要立即执行的脚本已经被执行（不论执行顺序）时的时间戳。</span>
	domContentLoadedEventEnd<span class="token operator">:</span> <span class="token number">1543806783216</span><span class="token punctuation">,</span>

	<span class="token comment">// 当前文档解析完成，即Document.readyState 变为 'complete'且相对应的readystatechange 被触发时的时间戳</span>
	domComplete<span class="token operator">:</span> <span class="token number">1543806783796</span><span class="token punctuation">,</span>

	<span class="token comment">// load事件被发送时的时间戳。如果这个事件还未被发送，它的值将会是0。</span>
	loadEventStart<span class="token operator">:</span> <span class="token number">1543806783796</span><span class="token punctuation">,</span>

	<span class="token comment">// 当load事件结束，即加载事件完成时的时间戳。如果这个事件还未被发送，或者尚未完成，它的值将会是0.</span>
	loadEventEnd<span class="token operator">:</span> <span class="token number">1543806783802</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过以上数据，我们可以得到几个有用的时间：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 重定向耗时</span>
redirect<span class="token operator">:</span> timing<span class="token punctuation">.</span>redirectEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>redirectStart<span class="token punctuation">,</span>
<span class="token comment">// DOM 渲染耗时</span>
dom<span class="token operator">:</span> timing<span class="token punctuation">.</span>domComplete <span class="token operator">-</span> timing<span class="token punctuation">.</span>domLoading<span class="token punctuation">,</span>
<span class="token comment">// 页面加载耗时</span>
load<span class="token operator">:</span> timing<span class="token punctuation">.</span>loadEventEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">,</span>
<span class="token comment">// 页面卸载耗时</span>
unload<span class="token operator">:</span> timing<span class="token punctuation">.</span>unloadEventEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>unloadEventStart<span class="token punctuation">,</span>
<span class="token comment">// 请求耗时</span>
request<span class="token operator">:</span> timing<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>requestStart<span class="token punctuation">,</span>
<span class="token comment">// 获取性能信息时当前时间</span>
time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre></div><p>还有一个比较重要的时间就是<strong>白屏时间</strong>，它指从输入网址，到页面开始显示内容的时间。</p> <p>将以下脚本放在 <code>&lt;/head&gt;</code> 前面就能获取白屏时间。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    whiteScreen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart
    <span class="token comment">// 通过 domLoading 和 navigationStart 也可以</span>
    whiteScreen <span class="token operator">=</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>domLoading <span class="token operator">-</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>通过这几个时间，就可以得知页面首屏加载性能如何了。</p> <p>另外，通过 <code>window.performance.getEntriesByType('resource')</code> 这个方法，我们还可以获取相关资源（js、css、img...）的加载时间，它会返回页面当前所加载的所有资源。</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de3d1675e6f04422ba361f87b935ddb0~tplv-k3u1fbpfcp-zoom-1.image" alt="在这里插入图片描述"></p> <p>它一般包括以下几个类型：</p> <ul><li>sciprt</li> <li>link</li> <li>img</li> <li>css</li> <li>fetch</li> <li>other</li> <li>xmlhttprequest</li></ul> <p>我们只需用到以下几个信息：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 资源的名称</span>
name<span class="token operator">:</span> item<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
<span class="token comment">// 资源加载耗时</span>
duration<span class="token operator">:</span> item<span class="token punctuation">.</span>duration<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token comment">// 资源大小</span>
size<span class="token operator">:</span> item<span class="token punctuation">.</span>transferSize<span class="token punctuation">,</span>
<span class="token comment">// 资源所用协议</span>
protocol<span class="token operator">:</span> item<span class="token punctuation">.</span>nextHopProtocol<span class="token punctuation">,</span>
</code></pre></div><p>现在，写几行代码来收集这些数据。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 收集性能信息</span>
<span class="token keyword">const</span> <span class="token function-variable function">getPerformance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>performance<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">const</span> timing <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>timing
    <span class="token keyword">const</span> performance <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">// 重定向耗时</span>
        redirect<span class="token operator">:</span> timing<span class="token punctuation">.</span>redirectEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>redirectStart<span class="token punctuation">,</span>
        <span class="token comment">// 白屏时间</span>
        whiteScreen<span class="token operator">:</span> whiteScreen<span class="token punctuation">,</span>
        <span class="token comment">// DOM 渲染耗时</span>
        dom<span class="token operator">:</span> timing<span class="token punctuation">.</span>domComplete <span class="token operator">-</span> timing<span class="token punctuation">.</span>domLoading<span class="token punctuation">,</span>
        <span class="token comment">// 页面加载耗时</span>
        load<span class="token operator">:</span> timing<span class="token punctuation">.</span>loadEventEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">,</span>
        <span class="token comment">// 页面卸载耗时</span>
        unload<span class="token operator">:</span> timing<span class="token punctuation">.</span>unloadEventEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>unloadEventStart<span class="token punctuation">,</span>
        <span class="token comment">// 请求耗时</span>
        request<span class="token operator">:</span> timing<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>requestStart<span class="token punctuation">,</span>
        <span class="token comment">// 获取性能信息时当前时间</span>
        time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> performance
<span class="token punctuation">}</span>

<span class="token comment">// 获取资源信息</span>
<span class="token keyword">const</span> <span class="token function-variable function">getResources</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>performance<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">getEntriesByType</span><span class="token punctuation">(</span><span class="token string">'resource'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> resource <span class="token operator">=</span> <span class="token punctuation">{</span>
        xmlhttprequest<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        css<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        other<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        script<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        img<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        link<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        fetch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// 获取资源信息时当前时间</span>
        time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> arry <span class="token operator">=</span> resource<span class="token punctuation">[</span>item<span class="token punctuation">.</span>initiatorType<span class="token punctuation">]</span>
        arry <span class="token operator">&amp;&amp;</span> arry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">// 资源的名称</span>
            name<span class="token operator">:</span> item<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
            <span class="token comment">// 资源加载耗时</span>
            duration<span class="token operator">:</span> item<span class="token punctuation">.</span>duration<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 资源大小</span>
            size<span class="token operator">:</span> item<span class="token punctuation">.</span>transferSize<span class="token punctuation">,</span>
            <span class="token comment">// 资源所用协议</span>
            protocol<span class="token operator">:</span> item<span class="token punctuation">.</span>nextHopProtocol<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> resource
<span class="token punctuation">}</span>
</code></pre></div><h4 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h4> <p>通过对性能及资源信息的解读，我们可以判断出页面加载慢有以下几个原因：</p> <ol><li>资源过多、过大</li> <li>网速过慢</li> <li>DOM 元素过多</li></ol> <p>除了用户网速过慢，我们没办法之外，其他两个原因都是有办法解决的，关于如何做性能优化我们将在下一章学习。</p> <p><strong>PS</strong>：其实页面加载慢还有其他原因，例如没有使用按需加载、没有使用 CDN 等等。不过在这里我们强调的是仅通过对性能和资源信息的解读来得知原因。</p> <h3 id="错误数据采集"><a href="#错误数据采集" class="header-anchor">#</a> 错误数据采集</h3> <p>目前所能捕捉的错误有三种:</p> <ol><li>资源加载错误，通过 <code>addEventListener('error', callback, true)</code> 在捕获阶段捕捉资源加载失败错误。</li> <li>js 执行错误，通过 <code>window.onerror</code> 捕捉 js 错误。</li> <li>promise 错误，通过 <code>addEventListener('unhandledrejection', callback)</code>捕捉 promise 错误，但是没有发生错误的行数，列数等信息，只能手动抛出相关错误信息。</li></ol> <p>我们可以建一个错误数组变量 <code>errors</code> 在错误发生时，将错误的相关信息添加到数组，然后在某个阶段统一上报，具体如何操作请看下面的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 捕获资源加载失败错误 js css img...</span>
<span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            type<span class="token operator">:</span> target<span class="token punctuation">.</span>localName<span class="token punctuation">,</span>
            url<span class="token operator">:</span> target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
            msg<span class="token operator">:</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' is load error'</span><span class="token punctuation">,</span>
            <span class="token comment">// 错误发生的时间</span>
            time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token comment">// 监听 js 错误</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'javascript'</span><span class="token punctuation">,</span>
        row<span class="token operator">:</span> row<span class="token punctuation">,</span>
        col<span class="token operator">:</span> col<span class="token punctuation">,</span>
        msg<span class="token operator">:</span> error <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>stack<span class="token operator">?</span> error<span class="token punctuation">.</span>stack <span class="token operator">:</span> msg<span class="token punctuation">,</span>
        url<span class="token operator">:</span> url<span class="token punctuation">,</span>
        <span class="token comment">// 错误发生的时间</span>
        time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听 promise 错误 缺点是获取不到行数数据</span>
<span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unhandledrejection'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'promise'</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>reason <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>reason<span class="token punctuation">.</span>msg<span class="token punctuation">)</span> <span class="token operator">||</span> e<span class="token punctuation">.</span>reason <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token comment">// 错误发生的时间</span>
        time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="小结-2"><a href="#小结-2" class="header-anchor">#</a> 小结</h4> <p>通过错误收集，可以了解到网站发生错误的类型及数量，从而做出相应的调整，以减少错误发生。</p> <h2 id="数据上报"><a href="#数据上报" class="header-anchor">#</a> 数据上报</h2> <h3 id="性能数据上报"><a href="#性能数据上报" class="header-anchor">#</a> 性能数据上报</h3> <p>性能数据可以在页面加载完之后上报，尽量不要对页面性能造成影响。</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在浏览器空闲时间获取性能及资源信息</span>
    <span class="token comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>requestIdleCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            monitor<span class="token punctuation">.</span>performance <span class="token operator">=</span> <span class="token function">getPerformance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            monitor<span class="token punctuation">.</span>resources <span class="token operator">=</span> <span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            monitor<span class="token punctuation">.</span>performance <span class="token operator">=</span> <span class="token function">getPerformance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            monitor<span class="token punctuation">.</span>resources <span class="token operator">=</span> <span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然，你也可以设一个定时器，循环上报。不过每次上报最好做一下对比去重再上报，避免同样的数据重复上报。</p> <h3 id="错误数据上报"><a href="#错误数据上报" class="header-anchor">#</a> 错误数据上报</h3> <p>我在 DEMO（在小节末尾） 里提供的代码，是用一个 <code>errors</code> 数组收集所有的错误，再在某一阶段统一上报（延时上报）。</p> <p>其实，也可以改成在错误发生时上报（即时上报）。这样可以避免“收集完错误，但延时上报还没触发，用户却已经关掉网页导致错误数据丢失”的问题。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 监听 js 错误</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'javascript'</span><span class="token punctuation">,</span>
        row<span class="token operator">:</span> row<span class="token punctuation">,</span>
        col<span class="token operator">:</span> col<span class="token punctuation">,</span>
        msg<span class="token operator">:</span> error <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>stack<span class="token operator">?</span> error<span class="token punctuation">.</span>stack <span class="token operator">:</span> msg<span class="token punctuation">,</span>
        url<span class="token operator">:</span> url<span class="token punctuation">,</span>
        <span class="token comment">// 错误发生的时间</span>
        time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 即时上报</span>
    axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外，还可以使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon" target="_blank" rel="noopener noreferrer">navigator.sendBeacon()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来进行上报。</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unload'</span><span class="token punctuation">,</span> logData<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">logData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">&quot;/log&quot;</span><span class="token punctuation">,</span> analyticsData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它的技术特点是：</p> <blockquote><p>使用 sendBeacon() 方法会使用户代理（浏览器）在有机会时异步地向服务器发送数据，同时不会延迟页面的卸载或影响下一导航的载入性能。这就解决了提交分析数据时的所有的问题：数据可靠，传输异步并且不会影响下一页面的加载。</p></blockquote> <h3 id="demo-代码"><a href="#demo-代码" class="header-anchor">#</a> DEMO 代码</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">function</span> <span class="token function">monitorInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> monitor <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token comment">// 数据上传地址</span>
                url<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                <span class="token comment">// 性能信息</span>
                performance<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 资源信息</span>
                resources<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 错误信息</span>
                errors<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token comment">// 用户信息</span>
                user<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 屏幕宽度</span>
                    screen<span class="token operator">:</span> screen<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
                    <span class="token comment">// 屏幕高度</span>
                    height<span class="token operator">:</span> screen<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
                    <span class="token comment">// 浏览器平台</span>
                    platform<span class="token operator">:</span> navigator<span class="token punctuation">.</span>platform<span class="token punctuation">,</span>
                    <span class="token comment">// 浏览器的用户代理信息</span>
                    userAgent<span class="token operator">:</span> navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">,</span>
                    <span class="token comment">// 浏览器用户界面的语言</span>
                    language<span class="token operator">:</span> navigator<span class="token punctuation">.</span>language<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 手动添加错误</span>
                <span class="token function">addError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                    <span class="token keyword">const</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> row<span class="token punctuation">,</span> col <span class="token punctuation">}</span> <span class="token operator">=</span> error
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> obj<span class="token punctuation">.</span>type <span class="token operator">=</span> type
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> obj<span class="token punctuation">.</span>msg <span class="token operator">=</span> msg
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">)</span> obj<span class="token punctuation">.</span>url <span class="token operator">=</span> url
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>row<span class="token punctuation">)</span> obj<span class="token punctuation">.</span>row <span class="token operator">=</span> row
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>col<span class="token punctuation">)</span> obj<span class="token punctuation">.</span>col <span class="token operator">=</span> col
                    obj<span class="token punctuation">.</span>time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 重置 monitor 对象</span>
                <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    window<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">clearResourceTimings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    monitor<span class="token punctuation">.</span>performance <span class="token operator">=</span> <span class="token function">getPerformance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    monitor<span class="token punctuation">.</span>resources <span class="token operator">=</span> <span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    monitor<span class="token punctuation">.</span>errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 清空 error 信息</span>
                <span class="token function">clearError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    monitor<span class="token punctuation">.</span>errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 上传监控数据</span>
                <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 自定义上传</span>
                    <span class="token comment">// axios.post({</span>
                    <span class="token comment">//     url: monitor.url,</span>
                    <span class="token comment">//     data: {</span>
                    <span class="token comment">//         performance,</span>
                    <span class="token comment">//         resources,</span>
                    <span class="token comment">//         errors,</span>
                    <span class="token comment">//         user,</span>
                    <span class="token comment">//     }</span>
                    <span class="token comment">// })</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 设置数据上传地址</span>
                <span class="token function">setURL</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    monitor<span class="token punctuation">.</span>url <span class="token operator">=</span> url
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 获取性能信息</span>
            <span class="token keyword">const</span> <span class="token function-variable function">getPerformance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>performance<span class="token punctuation">)</span> <span class="token keyword">return</span>
                <span class="token keyword">const</span> timing <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>timing
                <span class="token keyword">const</span> performance <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 重定向耗时</span>
                    redirect<span class="token operator">:</span> timing<span class="token punctuation">.</span>redirectEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>redirectStart<span class="token punctuation">,</span>
                    <span class="token comment">// 白屏时间</span>
                    whiteScreen<span class="token operator">:</span> whiteScreen<span class="token punctuation">,</span>
                    <span class="token comment">// DOM 渲染耗时</span>
                    dom<span class="token operator">:</span> timing<span class="token punctuation">.</span>domComplete <span class="token operator">-</span> timing<span class="token punctuation">.</span>domLoading<span class="token punctuation">,</span>
                    <span class="token comment">// 页面加载耗时</span>
                    load<span class="token operator">:</span> timing<span class="token punctuation">.</span>loadEventEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">,</span>
                    <span class="token comment">// 页面卸载耗时</span>
                    unload<span class="token operator">:</span> timing<span class="token punctuation">.</span>unloadEventEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>unloadEventStart<span class="token punctuation">,</span>
                    <span class="token comment">// 请求耗时</span>
                    request<span class="token operator">:</span> timing<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> timing<span class="token punctuation">.</span>requestStart<span class="token punctuation">,</span>
                    <span class="token comment">// 获取性能信息时当前时间</span>
                    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> performance
            <span class="token punctuation">}</span>

            <span class="token comment">// 获取资源信息</span>
            <span class="token keyword">const</span> <span class="token function-variable function">getResources</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>performance<span class="token punctuation">)</span> <span class="token keyword">return</span>
                <span class="token keyword">const</span> data <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span><span class="token function">getEntriesByType</span><span class="token punctuation">(</span><span class="token string">'resource'</span><span class="token punctuation">)</span>
                <span class="token keyword">const</span> resource <span class="token operator">=</span> <span class="token punctuation">{</span>
                    xmlhttprequest<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    css<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    other<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    script<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    img<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    link<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    fetch<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token comment">// 获取资源信息时当前时间</span>
                    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>

                data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> arry <span class="token operator">=</span> resource<span class="token punctuation">[</span>item<span class="token punctuation">.</span>initiatorType<span class="token punctuation">]</span>
                    arry <span class="token operator">&amp;&amp;</span> arry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token comment">// 资源的名称</span>
                        name<span class="token operator">:</span> item<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                        <span class="token comment">// 资源加载耗时</span>
                        duration<span class="token operator">:</span> item<span class="token punctuation">.</span>duration<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token comment">// 资源大小</span>
                        size<span class="token operator">:</span> item<span class="token punctuation">.</span>transferSize<span class="token punctuation">,</span>
                        <span class="token comment">// 资源所用协议</span>
                        protocol<span class="token operator">:</span> item<span class="token punctuation">.</span>nextHopProtocol<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>

                <span class="token keyword">return</span> resource
            <span class="token punctuation">}</span>

            window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 在浏览器空闲时间获取性能及资源信息 https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>requestIdleCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    window<span class="token punctuation">.</span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        monitor<span class="token punctuation">.</span>performance <span class="token operator">=</span> <span class="token function">getPerformance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        monitor<span class="token punctuation">.</span>resources <span class="token operator">=</span> <span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'页面性能信息'</span><span class="token punctuation">)</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>performance<span class="token punctuation">)</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'页面资源信息'</span><span class="token punctuation">)</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>resources<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        monitor<span class="token punctuation">.</span>performance <span class="token operator">=</span> <span class="token function">getPerformance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        monitor<span class="token punctuation">.</span>resources <span class="token operator">=</span> <span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'页面性能信息'</span><span class="token punctuation">)</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>performance<span class="token punctuation">)</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'页面资源信息'</span><span class="token punctuation">)</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>resources<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 捕获资源加载失败错误 js css img...</span>
            <span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target
                <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        type<span class="token operator">:</span> target<span class="token punctuation">.</span>localName<span class="token punctuation">,</span>
                        url<span class="token operator">:</span> target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
                        msg<span class="token operator">:</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> target<span class="token punctuation">.</span>href<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' is load error'</span><span class="token punctuation">,</span>
                        <span class="token comment">// 错误发生的时间</span>
                        time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>

                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'所有的错误信息'</span><span class="token punctuation">)</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

            <span class="token comment">// 监听 js 错误</span>
            window<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> url<span class="token punctuation">,</span> row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    type<span class="token operator">:</span> <span class="token string">'javascript'</span><span class="token punctuation">,</span> <span class="token comment">// 错误类型</span>
                    row<span class="token operator">:</span> row<span class="token punctuation">,</span> <span class="token comment">// 发生错误时的代码行数</span>
                    col<span class="token operator">:</span> col<span class="token punctuation">,</span> <span class="token comment">// 发生错误时的代码列数</span>
                    msg<span class="token operator">:</span> error <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>stack<span class="token operator">?</span> error<span class="token punctuation">.</span>stack <span class="token operator">:</span> msg<span class="token punctuation">,</span> <span class="token comment">// 错误信息</span>
                    url<span class="token operator">:</span> url<span class="token punctuation">,</span> <span class="token comment">// 错误文件</span>
                    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 错误发生的时间</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>

                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'所有的错误信息'</span><span class="token punctuation">)</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 监听 promise 错误 缺点是获取不到行数数据</span>
            <span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unhandledrejection'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                monitor<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    type<span class="token operator">:</span> <span class="token string">'promise'</span><span class="token punctuation">,</span>
                    msg<span class="token operator">:</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>reason <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>reason<span class="token punctuation">.</span>msg<span class="token punctuation">)</span> <span class="token operator">||</span> e<span class="token punctuation">.</span>reason <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
                    <span class="token comment">// 错误发生的时间</span>
                    time<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>

                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'所有的错误信息'</span><span class="token punctuation">)</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>monitor<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span> monitor
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> monitor <span class="token operator">=</span> <span class="token function">monitorInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>错误测试按钮1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>错误测试按钮2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>错误测试按钮3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://avatars3.githubusercontent.com/u/22117876?s=460&amp;v=4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>192.168.10.15/test.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.btn1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.btn2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            msg<span class="token operator">:</span> <span class="token string">'test.js promise is error'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.btn3'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token string">'这是一个手动扔出的错误'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="扩展"><a href="#扩展" class="header-anchor">#</a> 扩展</h2> <h3 id="spa"><a href="#spa" class="header-anchor">#</a> SPA</h3> <p><code>window.performance</code> API 是有缺点的，在 SPA 切换路由时，<code>window.performance.timing</code> 的数据不会更新。
所以我们需要另想办法来统计切换路由到加载完成的时间。
拿 Vue 举例，一个可行的办法就是切换路由时，在路由的全局前置守卫 <code>beforeEach</code> 里获取开始时间，在组件的 <code>mounted</code> 钩子里执行 <code>vm.$nextTick</code> 函数来获取组件的渲染完毕时间。</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'setPageLoadedStartTime'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'setPageLoadedTime'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>pageLoadedStartTime<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>除了性能和错误监控，其实我们还可以收集更多的信息。</p> <h3 id="用户信息收集"><a href="#用户信息收集" class="header-anchor">#</a> 用户信息收集</h3> <h4 id="navigator"><a href="#navigator" class="header-anchor">#</a> navigator</h4> <p>使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/navigator" target="_blank" rel="noopener noreferrer">window.navigator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 可以收集到用户的设备信息，操作系统，浏览器信息...</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5a76a62e4174599b5b802f25cb4ea7a~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <h4 id="uv-unique-visitor"><a href="#uv-unique-visitor" class="header-anchor">#</a> UV（Unique visitor）</h4> <p>是指通过互联网浏览这个网页的访客，00:00-24:00 内相同的设备访问只被计算一次。一天内同个访客多次访问仅计算一个 UV。</p> <p>在用户访问网站时，可以生成一个随机字符串+时间日期，保存在本地。在网页发生请求时（如果超过当天24小时，则重新生成），把这些参数传到后端，后端利用这些信息生成 UV 统计报告。</p> <h4 id="pv-page-view"><a href="#pv-page-view" class="header-anchor">#</a> PV（Page View）</h4> <p>即页面浏览量或点击量，用户每 1 次对网站中的每个网页访问均被记录 1 个PV。用户对同一页面的多次访问，访问量累计，用以衡量网站用户访问的网页数量。</p> <h4 id="页面停留时间"><a href="#页面停留时间" class="header-anchor">#</a> 页面停留时间</h4> <h5 id="传统网站"><a href="#传统网站" class="header-anchor">#</a> 传统网站</h5> <p>用户在进入 A 页面时，通过后台请求把用户进入页面的时间捎上。过了 10 分钟，用户进入 B 页面，这时后台可以通过接口捎带的参数可以判断出用户在 A 页面停留了 10 分钟。</p> <h5 id="spa-2"><a href="#spa-2" class="header-anchor">#</a> SPA</h5> <p>可以利用 router 来获取用户停留时间，拿 Vue 举例，通过 <code>router.beforeEach</code>、<code>destroyed</code> 这两个钩子函数来获取用户停留该路由组件的时间。</p> <h4 id="浏览深度"><a href="#浏览深度" class="header-anchor">#</a> 浏览深度</h4> <p>通过 <code>document.documentElement.scrollTop</code> 属性以及屏幕高度，可以判断用户是否浏览完网站内容。</p> <h4 id="页面跳转来源"><a href="#页面跳转来源" class="header-anchor">#</a> 页面跳转来源</h4> <p>通过 <code>document.referrer</code> 属性，可以知道用户是从哪个网站跳转而来。</p> <h3 id="小结-3"><a href="#小结-3" class="header-anchor">#</a> 小结</h3> <p>通过分析用户数据，我们可以了解到用户的浏览习惯、爱好等等信息，想想真是恐怖，毫无隐私可言。</p> <h2 id="前端监控部署"><a href="#前端监控部署" class="header-anchor">#</a> 前端监控部署</h2> <p>前面说的都是监控原理，但要实现还是得自己动手写代码。为了避免麻烦，我们可以用现有的工具 <a href="https://docs.sentry.io/" target="_blank" rel="noopener noreferrer">sentry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 去做这件事。</p> <p>sentry 是一个用 python 写的性能和错误监控工具，你可以使用 sentry 提供的服务（免费功能少），也可以自己部署服务。现在来看一下如何使用 sentry 提供的服务实现监控。</p> <h3 id="注册账号"><a href="#注册账号" class="header-anchor">#</a> 注册账号</h3> <p>打开 <code>https://sentry.io/signup/</code> 网站，进行注册。</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/efae84d48d4143f895dfda7ef88a3354~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3846c1b87e84b6d90c771b0c8198068~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>选择项目，这里用 Vue 做示例。</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ed48cc42fa194f9cbca11550b471139e~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <h3 id="安装-sentry-依赖"><a href="#安装-sentry-依赖" class="header-anchor">#</a> 安装 sentry 依赖</h3> <p>选完项目，下面会有具体的 sentry 依赖安装指南。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ddfb72545299440a940b650d577cf77f~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>根据提示，在你的 Vue 项目执行这段代码 <code>npm install --save @sentry/browser @sentry/integrations @sentry/tracing</code>，安装 sentry 所需的依赖。</p> <p>再将下面的代码拷到你的 <code>main.js</code>，放在 <code>new Vue()</code> 之前。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Sentry <span class="token keyword">from</span> <span class="token string">&quot;@sentry/browser&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Vue <span class="token keyword">as</span> VueIntegration <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@sentry/integrations&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Integrations <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@sentry/tracing&quot;</span><span class="token punctuation">;</span>

Sentry<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  dsn<span class="token operator">:</span> <span class="token string">&quot;xxxxx&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 这里是你的 dsn 地址，注册完就有</span>
  integrations<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">VueIntegration</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      Vue<span class="token punctuation">,</span>
      tracing<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Integrations<span class="token punctuation">.</span>BrowserTracing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token comment">// We recommend adjusting this value in production, or using tracesSampler</span>
  <span class="token comment">// for finer control</span>
  tracesSampleRate<span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后点击第一步中的 <code>skip this onboarding</code>，进入控制台页面。</p> <p>如果忘了自己的 DSN，请点击左边的菜单栏选择 <code>Settings</code> -&gt; <code>Projects</code> -&gt; 点击自己的项目 -&gt; <code>Client Keys(DSN)</code>。</p> <h3 id="创建第一个错误"><a href="#创建第一个错误" class="header-anchor">#</a> 创建第一个错误</h3> <p>在你的 Vue 项目执行一个打印语句 <code>console.log(b)</code>。</p> <p>这时点开 sentry 主页的 issues 一项，可以发现有一个报错信息 <code>b is not defined</code>：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/24e28dd2f6034719bdfc35d8716b6ddf~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>这个报错信息包含了错误的具体信息，还有你的 IP、浏览器信息等等。</p> <p>但奇怪的是，我们的浏览器控制台并没有输出报错信息。</p> <p>这是因为被 sentry 屏蔽了，所以我们需要加上一个选项 <code>logErrors: true</code>。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/98dd3b5cb75649eaa2e2f0648ed5fd5b~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>然后再查看页面，发现控制台也有报错信息了：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa26d5007bc24c919c56283dfe2c92b1~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <h3 id="上传-sourcemap"><a href="#上传-sourcemap" class="header-anchor">#</a> 上传 sourcemap</h3> <p>一般打包后的代码都是经过压缩的，如果没有 sourcemap，即使有报错信息，你也很难根据提示找到对应的源码在哪。</p> <p>下面来看一下如何上传 sourcemap。</p> <p>首先创建 auth token。</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5cf704d9cefa4e84941caaea3c096b69~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/77dd5fde72634376a53a929fe3a06f66~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb9cff485e0b4120a6168040d81380bc~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7b07fc31573d43b9ac59522b144bcd4e~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>这个生成的 token 一会要用到。</p> <p>安装 <code>sentry-cli</code> 和 <code>@sentry/webpack-plugin</code>：</p> <div class="language- extra-class"><pre class="language-text"><code>npm install sentry-cli-binary -g
npm install --save-dev @sentry/webpack-plugin
</code></pre></div><p>安装完上面两个插件后，在项目根目录创建一个 <code>.sentryclirc</code> 文件（不要忘了在 <code>.gitignore</code> 把这个文件添加上，以免暴露 token），内容如下：</p> <div class="language- extra-class"><pre class="language-text"><code>[auth]
token=xxx

[defaults]
url=https://sentry.io/
org=woai3c
project=woai3c
</code></pre></div><p>把 xxx 替换成刚才生成的 token。</p> <p><code>org</code> 是你的组织名称。</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c01d66fa8c6144b2bcc8c2bad7be46f7~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><code>project</code> 是你的项目名称，根据下面的提示可以找到。</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2bc1398957f4bc887365872e5c19724~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ab01b819e9044e3984406fa84bd9d0fa~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>在项目下新建 <code>vue.config.js</code> 文件，把下面的内容填进去：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> SentryWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@sentry/webpack-plugin'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    configureWebpack<span class="token operator">:</span> <span class="token punctuation">{</span>
        plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token keyword">new</span> <span class="token class-name">SentryWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                include<span class="token operator">:</span> <span class="token string">'./dist'</span><span class="token punctuation">,</span> <span class="token comment">// 打包后的目录</span>
                ignore<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> <span class="token string">'vue.config.js'</span><span class="token punctuation">,</span> <span class="token string">'babel.config.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 只在生产环境下上传 sourcemap</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">==</span> <span class="token string">'production'</span><span class="token operator">?</span> config <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>填完以后，执行 <code>npm run build</code>，就可以看到 <code>sourcemap</code> 的上传结果了。</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3b0b21bca0324f8a9e296d4d0aa782e0~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>我们再来看一下没上传 sourcemap 和上传之后的报错信息对比。</p> <p><strong>未上传 sourcemap</strong></p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/37b07f06365940269eac40ae953ea45e~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ad3ab31aded40bdb788e5a117b1611c~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><strong>已上传 sourcemap</strong></p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b9406ccfc46c42d1b9f499fb3f5e4280~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f066c98785e4597833b4a1600d27aa8~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>可以看到，上传 sourcemap 后的报错信息更加准确。</p> <h3 id="切换中文环境和时区"><a href="#切换中文环境和时区" class="header-anchor">#</a> 切换中文环境和时区</h3> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7523abeeda95418880ff5683b1baf8a9~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/76b994e92044402c82dec0b2d1e5a762~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>选完刷新即可。</p> <h3 id="性能监控"><a href="#性能监控" class="header-anchor">#</a> 性能监控</h3> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69b21fe514ee466292306c2ce4eaa672~tplv-k3u1fbpfcp-watermark.image" alt=""></p> <p>打开 performance 选项，就能看到你每个项目的运行情况。具体的参数解释请看文档 <a href="https://docs.sentry.io/product/performance/" target="_blank" rel="noopener noreferrer">Performance Monitoring<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="小结-4"><a href="#小结-4" class="header-anchor">#</a> 小结</h2> <p>随着 web 技术的发展，现在前端项目的规模也越来越大。在监控系统的帮助下，我们可以更加清楚的了解项目的运行情况，根据采集到的错误数据和性能数据对项目做针对性的优化。</p> <p>下一章我们将讲解如何做性能优化。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/introduction-to-front-end-engineering/06.html" class="prev">
        自动化部署
      </a></span> <span class="next"><a href="/introduction-to-front-end-engineering/08.html">
        性能优化（一）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/introduction-to-front-end-engineering/assets/js/app.5017e671.js" defer></script><script src="/introduction-to-front-end-engineering/assets/js/2.08dab6ba.js" defer></script><script src="/introduction-to-front-end-engineering/assets/js/13.f75ac3cb.js" defer></script>
  </body>
</html>
